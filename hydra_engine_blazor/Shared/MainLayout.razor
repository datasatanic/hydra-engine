@using hydra_engine_blazor.Models
@inherits LayoutComponentBase
@inject SettingsContainer SettingsContainer
@inject NavigationManager Navigation
@using Blazored.Toast.Configuration
@inject IJSRuntime _jsRuntime
@implements IAsyncDisposable
<div class="page">
    <div @ref="menuContainer" class="menu-container">
        <h1>Dockermodule</h1>
        <div class="search-container">
            <div class="input-search-container">
                <input id="tree-search" type="search" value="@searchValue" @oninput="SearchCallback"/>
                <img/>
            </div>
            <div class="expand-collapse-container">
                <img @onclick="() => SettingsContainer.Expand=true"/>
                <img @onclick="() => SettingsContainer.Expand=false"/>
            </div>
        </div>
        <div class="sidebar">
            @if (searchForms.Count == 0)
            {
                foreach (var node in _settingsTree.Child)
                {
                    <NavMenu Settings="@node" Root="@node.Name" DisplayNamePath="@node.DisplayName"/>
                }
            }
            else
            {
                <ul class="search-list">
                    @foreach (var form in searchForms)
                    {
                        <li>
                            <div @onclick="() => Navigation.NavigateTo(form.Key)">@form.Value.Value</div>
                            <h4>@form.Value.Key[1..]</h4>
                        </li>
                    }
                </ul>
            }
            
        </div>
        <div class="slider-container" @ref="resizeContainer">
            <img class="slider"/>
        </div>
        
    </div>
    <main>
        <article>
            @Body
        </article>
    </main>
    <BlazoredToasts Position="ToastPosition.BottomRight"
                    Timeout="5"/>
</div>

@code{
    public ControlsMeta _settingsTree = new();
    private bool resize;
    private Dictionary<string,KeyValuePair<string,string>> searchForms;
    private string? searchValue;
    private double containerWidth = 460;
    private IJSObjectReference _module;
    ElementReference menuContainer;
    ElementReference resizeContainer;
    protected override async Task OnInitializedAsync()
    {
        SettingsContainer.Expand = true;
        searchForms = new Dictionary<string, KeyValuePair<string,string>>();
        var query = await SettingsContainer.GetTree();
        _settingsTree.Name = "tree";
        if (query != null)
        {
            JsonParser.DeserializeTree(query.ToString(),_settingsTree,_settingsTree.Child);
            SettingsContainer.ModifyTime = await SettingsContainer.GetModifiedTime();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await _jsRuntime.InvokeAsync<IJSObjectReference>("import", "./Shared/MainLayout.razor.js");
            await _module.InvokeVoidAsync("addListenersResize",resizeContainer);
        }
    }

    private void SearchCallback(ChangeEventArgs obj)
    {
        searchForms.Clear();
        searchValue = obj.Value?.ToString();
        FindForms(_settingsTree.Child,"","");
    }

    private void FindForms(List<ControlsMeta> forms,string root,string displayName)
    {
        foreach (var form in forms)
        {
            var outputUrl = root+"/"+form.Name;
            var displayNameUrl = displayName + "/" + form.DisplayName;
            if (form.DisplayName.Contains(searchValue,StringComparison.OrdinalIgnoreCase) & !string.IsNullOrEmpty(searchValue))
            {
                searchForms.Add(outputUrl,new KeyValuePair<string, string>(displayNameUrl,form.DisplayName));
            }
            FindForms(form.Child,outputUrl,displayNameUrl);
            
        }
    }
    public async ValueTask DisposeAsync()
    {
        if (_module != null)
        {
            await _module.InvokeVoidAsync("clearListenersResize",resizeContainer);
            await _module.DisposeAsync();
        }
    }

}